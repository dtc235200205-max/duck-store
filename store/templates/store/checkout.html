{% extends 'store/base.html' %}

{% block title %}Thanh toán - Duck Store{% endblock %}

{% block content %}
<h2 class="mb-4" style="font-weight: 800;">
    <i class="fas fa-credit-card me-2"></i>Thanh toán đơn hàng
</h2>

<div class="row mt-4 g-4">
    <div class="col-lg-8">
        <form method="post" class="card p-4" style="border-radius: 1.2rem;">
            {% csrf_token %}
            
            <!-- Delivery Address Section -->
            <div class="mb-4">
                <h5 class="mb-3" style="font-weight: 700;">
                    <i class="fas fa-map-marker-alt me-2" style="color: var(--primary);"></i>Địa chỉ giao hàng
                </h5>
                
                <!-- Location Search -->
                <div class="mb-3">
                    <div class="input-group">
                        <label class="input-group-text" style="min-width: 140px;"><strong>Tìm kiếm</strong></label>
                        <input type="text" id="location_search" class="form-control" placeholder="Nhập tên địa chỉ, quận, phường..." autocomplete="off">
                        <button class="btn btn-outline-primary" type="button" id="geolocate-btn" title="Tự động xác định vị trí hiện tại">
                            <i class="fas fa-crosshairs me-2"></i>Vị trí
                        </button>
                    </div>
                </div>

                <!-- Map Container -->
                <div class="mb-3">
                    <div id="map" style="height: 400px; border-radius: 0.7rem; border: 2px solid var(--border-color); display: none;"></div>
                    <div id="map-loading" class="text-center py-5 bg-light rounded">
                        <i class="fas fa-map fa-3x mb-3" style="color: #ccc; display: block;"></i>
                        <p class="text-muted">Bản đồ sẽ tải khi bạn nhập địa chỉ</p>
                    </div>
                </div>

                <!-- Address Text Area -->
                <div class="mb-3">
                    <label class="form-label"><strong>Chi tiết địa chỉ</strong></label>
                    <textarea name="delivery_address" id="delivery_address" class="form-control" rows="3" placeholder="Nhập hoặc chọn từ bản đồ ở trên. VD: 123 Đường ABC, Quận XYZ, TP. HCM" required></textarea>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>Hãy nhập đầy đủ địa chỉ bao gồm số nhà, tên đường, phường/xã, quận/huyện, thành phố
                    </small>
                </div>
            </div>

            <hr>

            <!-- Payment Method Section -->
            <div class="mb-4">
                <h5 class="mb-3" style="font-weight: 700;">
                    <i class="fas fa-wallet me-2" style="color: var(--accent);"></i>Phương thức thanh toán
                </h5>
                
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <div class="form-check custom-check">
                            <input class="form-check-input" type="radio" id="credit_card" name="payment_method" value="Thẻ tín dụng" required>
                            <label class="form-check-label" for="credit_card">
                                <i class="fas fa-credit-card me-2"></i>Thẻ tín dụng
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="form-check custom-check">
                            <input class="form-check-input" type="radio" id="debit_card" name="payment_method" value="Thẻ ghi nợ">
                            <label class="form-check-label" for="debit_card">
                                <i class="fas fa-credit-card me-2"></i>Thẻ ghi nợ
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="form-check custom-check">
                            <input class="form-check-input" type="radio" id="paypal" name="payment_method" value="PayPal">
                            <label class="form-check-label" for="paypal">
                                <i class="fab fa-paypal me-2"></i>PayPal
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="form-check custom-check">
                            <input class="form-check-input" type="radio" id="bank_transfer" name="payment_method" value="Chuyển khoản ngân hàng">
                            <label class="form-check-label" for="bank_transfer">
                                <i class="fas fa-university me-2"></i>Chuyển khoản ngân hàng
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="form-check custom-check">
                            <input class="form-check-input" type="radio" id="cod" name="payment_method" value="Thanh toán khi nhận hàng">
                            <label class="form-check-label" for="cod">
                                <i class="fas fa-hand-holding-usd me-2"></i>Thanh toán khi nhận hàng
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <hr>

            <!-- Discount Code Section -->
            <div class="mb-4">
                <h5 class="mb-3" style="font-weight: 700;">
                    <i class="fas fa-ticket-alt me-2" style="color: var(--success);"></i>Mã giảm giá (tùy chọn)
                </h5>
                <div class="input-group">
                    <input type="text" name="discount_code" class="form-control" placeholder="Nhập mã giảm giá nếu có...">
                    <button class="btn btn-outline-primary" type="button">
                        <i class="fas fa-check me-1"></i>Áp dụng
                    </button>
                </div>
            </div>

            <button type="submit" class="btn btn-success btn-lg w-100" style="font-weight: 700; padding: 1rem;">
                <i class="fas fa-check-circle me-2"></i>Xác nhận đặt hàng
            </button>
        </form>
    </div>

    <!-- Order Summary -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px; border-radius: 1.2rem;">
            <div class="card-body">
                <h5 class="card-title mb-3" style="font-weight: 700;">
                    <i class="fas fa-receipt me-2"></i>Tóm tắt đơn hàng
                </h5>
                <hr>
                {% if items %}
                    <div class="mb-3">
                        <h6 class="mb-2">Chi tiết sản phẩm:</h6>
                        {% for item in items %}
                        <div class="d-flex justify-content-between mb-2 small">
                            <span>{{ item.product.name }} x{{ item.quantity }}</span>
                            <strong>{{ item.subtotal }}K</strong>
                        </div>
                        {% endfor %}
                    </div>
                    <hr>
                    <div class="mb-2 d-flex justify-content-between">
                        <span><strong>Tạm tính:</strong></span>
                        <span><strong>{{ total }}K</strong></span>
                    </div>
                    <div class="mb-2 d-flex justify-content-between text-muted small">
                        <span>Vận chuyển:</span>
                        <span>Miễn phí</span>
                    </div>
                    <div class="mb-3 d-flex justify-content-between text-muted small">
                        <span>Thuế:</span>
                        <span>0K</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between" style="font-size: 1.3rem;">
                        <strong>Tổng cộng:</strong>
                        <strong style="color: var(--primary);">{{ total }}K</strong>
                    </div>
                {% else %}
                    <p class="text-muted text-center">Giỏ hàng trống</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Leaflet Maps Library (Free, no API key needed) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<!-- Leaflet Geocoder Plugin -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-control-geocoder/2.4.0/Control.Geocoder.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-control-geocoder/2.4.0/Control.Geocoder.min.js"></script>

<script>
    let map = null;
    let marker = null;
    const locationSearchInput = document.getElementById('location_search');
    const deliveryAddressInput = document.getElementById('delivery_address');
    const mapContainer = document.getElementById('map');
    const mapLoadingMsg = document.getElementById('map-loading');

    // Initialize map on address input focus or search
    function initializeMap() {
        if (map) return; // Already initialized
        
        mapContainer.style.display = 'block';
        mapLoadingMsg.style.display = 'none';

        // Default to Vietnam center
        map = L.map('map').setView([21.0285, 105.8542], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Click to place marker
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            setMarker(lat, lng);
            reverseGeocode(lat, lng);
        });

        // Auto-detect user location using geolocation
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    setMarker(lat, lng);
                    reverseGeocode(lat, lng);
                    map.setView([lat, lng], 15);
                },
                function(error) {
                    console.log('Geolocation error:', error.message);
                    // Fallback to default location (Hanoi)
                }
            );
        }
    }

    function setMarker(lat, lng) {
        if (marker) {
            map.removeLayer(marker);
        }
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 16);
    }

    function reverseGeocode(lat, lng) {
        // Using OpenStreetMap Nominatim for reverse geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(response => response.json())
            .then(data => {
                if (data.address) {
                    const address = data.address;
                    const fullAddress = data.display_name.substring(0, 100); // Limit to 100 chars
                    deliveryAddressInput.value = fullAddress;
                }
            })
            .catch(error => console.log('Geocoding error:', error));
    }

    // Search location
    locationSearchInput.addEventListener('change', function() {
        if (this.value.trim()) {
            initializeMap();
            
            // Use Nominatim for geocoding
            const query = this.value + ', Vietnam'; // Add Vietnam to search context
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=vn`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);
                        setMarker(lat, lng);
                        reverseGeocode(lat, lng);
                    } else {
                        alert('Không tìm thấy địa chỉ. Vui lòng nhập chi tiết hơn.');
                    }
                })
                .catch(error => alert('Lỗi tìm kiếm địa chỉ: ' + error));
        }
    });

    // Geolocation button handler
    document.addEventListener('DOMContentLoaded', function() {
        const geolocateBtn = document.getElementById('geolocate-btn');
        if (geolocateBtn) {
            geolocateBtn.addEventListener('click', function() {
                initializeMap();
                if (navigator.geolocation) {
                    geolocateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xác định...';
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            setMarker(lat, lng);
                            reverseGeocode(lat, lng);
                            map.setView([lat, lng], 15);
                            geolocateBtn.innerHTML = '<i class="fas fa-check me-2"></i>Đã xác định';
                            setTimeout(() => {
                                geolocateBtn.innerHTML = '<i class="fas fa-crosshairs me-2"></i>Vị trí';
                            }, 2000);
                        },
                        function(error) {
                            alert('Không thể xác định vị trí. Vui lòng kiểm tra quyền truy cập vị trí của trình duyệt.');
                            geolocateBtn.innerHTML = '<i class="fas fa-crosshairs me-2"></i>Vị trí';
                        }
                    );
                } else {
                    alert('Trình duyệt của bạn không hỗ trợ xác định vị trí.');
                }
            });
        }
    });

    // Initialize map on focus
    deliveryAddressInput.addEventListener('focus', function() {
        if (!map && !this.value) {
            locationSearchInput.focus();
        }
    });
</script>

<style>
    .custom-check {
        padding: 0.75rem;
        border-radius: 0.7rem;
        border: 2px solid var(--border-color);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .custom-check:hover {
        background-color: var(--light-bg);
        border-color: var(--primary);
    }

    .custom-check input:checked + label {
        color: var(--primary);
        font-weight: 700;
    }

    body.dark-mode .custom-check {
        border-color: var(--dark-border);
        background-color: transparent;
    }

    body.dark-mode .custom-check:hover {
        background-color: rgba(99, 102, 241, 0.1);
        border-color: var(--primary);
    }
</style>
{% endblock %}